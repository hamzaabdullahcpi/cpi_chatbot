<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPI ClimateDesk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Custom color for Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-red': '#b43c35',
                        'brand-red-dark': '#9c342e',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Page background */
        }
        /* Custom scrollbar */
        #content-area::-webkit-scrollbar {
            width: 6px;
        }
        #content-area::-webkit-scrollbar-track {
            background: transparent;
        }
        #content-area::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 3px;
        }
        #content-area::-webkit-scrollbar-thumb:hover {
            background: #cbd5e1;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        .choice-btn {
            transition: all 0.2s ease-in-out;
            border: 1px solid #e2e8f0;
        }
        .choice-btn:hover {
            background-color: #f8fafc;
            border-color: #b43c35;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        .suggestion-btn {
            transition: all 0.2s ease-in-out;
        }
        .suggestion-btn:hover {
            background-color: #f1f5f9;
            transform: translateY(-1px);
        }

        /* Thinking animation */
        .thinking-bubble span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-bubble span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-bubble span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen">
    <div class="w-full max-w-3xl h-[95vh] max-h-[800px] flex flex-col bg-white rounded-2xl shadow-2xl m-4 border border-slate-200">
        <!-- Header -->
        <header class="bg-white text-black p-5 rounded-t-2xl flex items-center justify-between flex-shrink-0 border-b border-slate-200">
            <div>
                <h1 class="text-2xl font-bold text-brand-red">CPI ClimateDesk</h1>
                <p class="text-sm text-slate-500">Simple explanations of climate finance topics.</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="methodology-button" class="text-slate-500 hover:text-brand-red font-semibold px-3 py-2 rounded-lg transition text-sm">
                    Methodology
                </button>
                <button id="start-over-button" class="hidden bg-slate-100 text-brand-red px-4 py-2 rounded-lg font-semibold hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-200 transition text-sm">
                    Start Over
                </button>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="content-area" class="flex-1 p-6 overflow-y-auto">
            <!-- Interactive flow or chat messages will be rendered here -->
        </main>
        
        <!-- Input Form -->
        <footer class="p-4 bg-white rounded-b-2xl border-t border-slate-200 flex-shrink-0">
            <form id="chat-form" class="flex items-center gap-3">
                <div class="relative flex-1">
                    <input type="text" id="user-input" placeholder="Ask a custom question..." class="w-full p-4 pl-5 pr-12 border border-slate-300 rounded-full focus:ring-2 focus:ring-brand-red focus:outline-none transition bg-slate-50">
                    <button type="submit" id="send-button" class="absolute right-2 top-1/2 -translate-y-1/2 bg-brand-red text-white w-10 h-10 rounded-full font-semibold hover:bg-brand-red-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-red-dark transition shadow-md hover:shadow-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </div>
            </form>
        </footer>
    </div>

    <script>
        const contentArea = document.getElementById('content-area');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const startOverButton = document.getElementById('start-over-button');
        const methodologyButton = document.getElementById('methodology-button');

        // --- CORE KNOWLEDGE BASE ---
        const instrumentDatabase = [
            { category: "Debt Financing", instrument: "Green bond", funding: "Capital markets, various investors", sectors: "Transport, Buildings, Energy, Waste, Water", objective: "Mitigation", user_type: ["All"], case_study_id: "cs1" },
            { category: "International Climate Finance", instrument: "Blended finance vehicles", funding: "Mix of public and private", sectors: "All", objective: "Mitigation and adaptation", user_type: ["All"], case_study_id: "cs2" },
            { category: "Public-Private Partnerships (PPP)", instrument: "Power purchase agreements (PPA)", funding: "Private companies, various investors", sectors: "Buildings and energy", objective: "Mitigation and adaptation", user_type: ["Private Sector", "City Official"], case_study_id: "cs3" },
            { category: "Risk Mitigation Instruments", instrument: "Partial or full risk guarantee", funding: "Governments, development banks", sectors: "All", objective: "Mitigation and adaptation", user_type: ["DFI", "National Government", "Private Sector"], case_study_id: "cs4" },
            { category: "Land Value Capture (LVC)", instrument: "Tax or fee-based land value capture", funding: "Private companies", sectors: "Transport, Buildings, Energy, Waste, Urban development, Green spaces", objective: "Mitigation and adaptation", user_type: ["City Official", "National Government"], case_study_id: "cs5" },
            { category: "Aggregation Models", instrument: "Pooled procurement", funding: "Commercial banks, private equity", sectors: "Transport, Buildings, Energy, Waste, Industry", objective: "Mitigation and adaptation", user_type: ["City Official", "Private Sector"], case_study_id: "cs6" },
            { category: "Leasing and Asset Finance Models", instrument: "Operating lease finance", funding: "Commercial banks, private equity", sectors: "Transport, Buildings", objective: "Mitigation", user_type: ["Private Sector", "City Official"], case_study_id: "cs7" },
            { category: "Payment for Ecosystem Services (PES)", instrument: "Public-private payment for ecosystem service (PES) schemes", funding: "Development banks, private companies", sectors: "Urban development, Green spaces, Water", objective: "Mitigation and adaptation", user_type: ["All"], case_study_id: "cs8" },
            { category: "Municipal Own Source Revenue", instrument: "Property tax", funding: "Private companies, Communities and individuals", sectors: "All", objective: "Mitigation and adaptation", user_type: ["City Official"] },
            { category: "National Government Transfers", instrument: "Intergovernmental transfer", funding: "Government", sectors: "All", objective: "Mitigation and adaptation", user_type: ["City Official", "National Government"] },
            { category: "Debt Financing", instrument: "General obligation bond (GO bond)", funding: "Government, Institutional investors", sectors: "Transport, Buildings, Energy, Waste, Green spaces", objective: "Mitigation and adaptation", user_type: ["City Official"] },
            { category: "Equity Financing", instrument: "Project level equity", funding: "Private equity, companies, individuals", sectors: "Transport, Buildings, Energy, Waste, Water, Disaster risk management", objective: "Mitigation and adaptation", user_type: ["Private Sector"] },
        ];

        const caseStudyDatabase = {
            "cs1": { title: "Green bond for infrastructure financing in Cape Town, South Africa", instrument: "Green bond", summary: "The City of Cape Town issued a green bond to finance a range of climate change mitigation and adaptation projects. This included investments in electric buses, water management infrastructure like water meter replacements, and energy efficiency in municipal buildings. The bond was oversubscribed, demonstrating strong investor appetite for verified green projects at the municipal level." },
            "cs2": { title: "Blended finance for the As-Samra Wastewater Treatment Plant in Jordan", instrument: "Blended finance vehicles", summary: "A combination of grants, concessional loans from development banks, and commercial loans were used to finance the expansion of a major wastewater treatment plant. The public and concessional funds helped to de-risk the project, making it a viable and attractive investment for private sector financiers." },
            "cs3": { title: "Dam Nai Wind Farm enabled through Vietnam's PPA Model", instrument: "Power purchase agreements (PPA)", summary: "A private developer built and operates the Dam Nai Wind Farm. The project was made financially viable through a long-term Power Purchase Agreement (PPA) with the national utility, which guarantees a fixed price for the electricity generated. This revenue certainty was critical for securing private investment." },
            "cs4": { title: "Risk guarantee for the Kigali Bulk Water Supply Plant in Rwanda", instrument: "Partial or full risk guarantee", summary: "A partial risk guarantee from the World Bank Group's Multilateral Investment Guarantee Agency (MIGA) was provided to the private financiers of this PPP project. The guarantee protected investors against non-commercial risks, such as political instability or breach of contract, which was essential for attracting private capital to a large-scale infrastructure project in the region." },
            "cs5": { title: "Land value capture for the Sabarmati Riverfront regeneration in Ahmedabad, India", instrument: "Tax or fee-based land value capture", summary: "The city reclaimed land along the riverfront, developed it with public infrastructure like parks and promenades, and then sold or leased a portion of this newly valuable land to private developers. The revenue generated from these land sales was a key source of funding for the entire urban regeneration project." },
            "cs6": { title: "Pooled procurement for purchasing e-buses in Santiago, Chile", instrument: "Pooled procurement", summary: "Instead of each bus operator purchasing a small number of electric buses, a central entity aggregated the demand from multiple operators to procure a large fleet at once. This bulk purchase resulted in a lower price per bus and created a large enough deal to attract international manufacturers and financiers." },
            "cs7": { title: "Leasing model for electric buses and charging infrastructure in Shenzhen, China", instrument: "Operating lease finance", summary: "The city of Shenzhen electrified its entire bus fleet of over 16,000 buses. This was achieved through a leasing model where bus operators pay a monthly fee to a separate company that owns the buses and charging infrastructure. This avoided a massive upfront capital cost for the operators and made the transition financially manageable." },
            "cs8": { title: "GROVE: crowdfunded payment for ecosystems services for mangroves in India", instrument: "Payment for Ecosystem Services (PES)", summary: "This project uses a crowdfunding platform to allow individuals and companies to pay for the planting and protection of mangrove forests in the Sundarbans. These mangroves provide critical ecosystem services, such as coastal protection from storms and carbon sequestration, benefiting local and global communities." }
        };


        function findInstrumentInfo(query) {
            const lowerQuery = query.toLowerCase();
            return instrumentDatabase.find(item => lowerQuery.includes(item.instrument.toLowerCase()));
        }

        function filterInstrumentsByCriteria(query) {
            const lowerQuery = query.toLowerCase();
            let results = instrumentDatabase;

            const keywordMap = {
                sector: ['transport', 'building', 'energy', 'waste', 'water', 'urban development', 'green space', 'disaster risk', 'industry'],
                objective: ['adaptation', 'mitigation'],
                funding: ['private', 'public', 'ppp']
            };

            const foundKeywords = {
                sector: keywordMap.sector.find(k => lowerQuery.includes(k)),
                objective: keywordMap.objective.find(k => lowerQuery.includes(k)),
                funding: keywordMap.funding.find(k => lowerQuery.includes(k))
            };

            if (foundKeywords.sector) {
                results = results.filter(item => item.sectors.toLowerCase().includes(foundKeywords.sector));
            }
            if (foundKeywords.objective) {
                results = results.filter(item => item.objective.toLowerCase().includes(foundKeywords.objective));
            }
            if (foundKeywords.funding) {
                if(foundKeywords.funding === 'private') {
                     results = results.filter(item => item.funding.toLowerCase().includes('private') || item.funding.toLowerCase().includes('commercial') || item.category.toLowerCase().includes('equity'));
                } else if (foundKeywords.funding === 'public') {
                     results = results.filter(item => item.funding.toLowerCase().includes('government') || item.category.toLowerCase().includes('municipal'));
                } else if (foundKeywords.funding === 'ppp') {
                     results = results.filter(item => item.category.toLowerCase().includes('ppp'));
                }
            }
            
            if (!foundKeywords.sector && !foundKeywords.objective && !foundKeywords.funding) {
                return [];
            }

            return results;
        }
        
        // --- SYSTEM PROMPT FOR GEMINI ---
        const systemPrompt = `
            You are a specialized AI assistant that explains financial instruments for city-level climate projects. Your goal is to provide succinct, informative, and structured explanations.

            **Your Task & Reasoning Logic:**
            1.  You will be given a user's query and, if available, some structured data from a core knowledge base (a toolkit).
            2.  **PRIORITIZE TOOLKIT DATA:** Your primary goal is to use the provided toolkit data to answer the user's question.
            3.  **ENRICH, DON'T REPLACE:** If the toolkit data is missing details needed for the required output format (e.g., it lacks "Key Steps" or "Benefits"), you must use your general knowledge to fill in those specific gaps.
            4.  **SEAMLESS OUTPUT:** The final answer must be a single, integrated response. **DO NOT** mention whether the information comes from the toolkit or your general knowledge.
            5.  **STRICT OUTPUT FORMAT (FOR INSTRUMENTS):** For any query about a specific financial instrument, you MUST format the response using the following 4-bullet point structure. Use bolding for the titles.
                * **Overview:** What the instrument is.
                * **How it is used:** A typical way it is applied in climate-related or urban finance contexts.
                * **Key Steps:** A few steps or mechanisms involved in implementing or operationalizing the instrument.
                * **Benefits:** Key advantages or strategic value of using this instrument.
            6.  **NARRATIVE FORMAT (FOR CASE STUDIES):** If the user asks about a case study, you MUST provide the summary in a clear, narrative paragraph. Do NOT use the 4-bullet point structure for case studies.
            7.  **HANDLE LISTS:** If the user asks a descriptive question (e.g., "instruments for adaptation") and you are given a list of matching instruments from the toolkit, your task is to summarize the list, explain that these are good options, and highlight 2-3 key examples. Do not use the 4-bullet point format for this summary.
        `;

        let chatHistory = [{ role: "model", parts: [{ text: systemPrompt }] }];
        let isChatActive = false;
        let userSelections = {};
        let lastDetailedResponse = "";

        // --- INTERACTIVE FLOW LOGIC ---
        
        function startInteractiveFlow() {
            contentArea.innerHTML = '';
            appendMessage('bot', "Welcome! To help me tailor the information, please tell me a bit about yourself. What is your role?");
            
            const roles = ["City Official", "Private Sector", "National Government", "DFI"];
            const buttonContainer = createButtonContainer(roles, (role) => {
                userSelections.role = role;
                showTailoredSuggestions();
            });
            contentArea.appendChild(buttonContainer);
            startOverButton.classList.add('hidden');
        }

        function showTailoredSuggestions() {
            contentArea.innerHTML = '';
            appendMessage('bot', "Based on your role, here are some financial instruments that might be most relevant for you. Select one to learn more, or ask a custom question below.");

            const filteredInstruments = instrumentDatabase.filter(item => {
                return item.user_type.includes(userSelections.role) || item.user_type.includes("All");
            });
            
            const suggestions = [...new Set(filteredInstruments.map(item => `Tell me about ${item.instrument}`))];
            
            if(suggestions.length > 0) {
                const questionContainer = createButtonContainer(suggestions, (query) => {
                    handleUserQuery(query);
                }, 'grid-cols-1 md:grid-cols-2');
                contentArea.appendChild(questionContainer);
            } else {
                 handleNoMatches();
            }
        }

        async function handleNoMatches() {
            appendMessage('bot', "I couldn't find a perfect match in my core database based on your specific criteria. Let me check my broader knowledge for some general suggestions...");
            
            const thinkingMessage = appendMessage('bot', 'thinking');
            
            const promptForLLM = `The user has the following profile: Role - ${userSelections.role}. The core database did not have a specific match. Based on your general knowledge of climate finance, suggest 2-3 financial instruments that could be relevant and briefly explain why.`;
            
            const botResponse = await getGeminiResponse(promptForLLM);
            
            contentArea.removeChild(thinkingMessage);
            appendMessage('bot', botResponse);
        }

        function createButtonContainer(items, onClick, gridClass = 'grid-cols-2') {
            const container = document.createElement('div');
            container.className = `grid ${gridClass} gap-3 mt-4 animate-fade-in`;
            items.forEach(item => {
                const button = document.createElement('button');
                button.className = 'w-full text-center p-4 text-slate-700 hover:text-black choice-btn rounded-lg bg-white';
                button.textContent = item;
                button.onclick = () => onClick(item);
                container.appendChild(button);
            });
            return container;
        }


        // --- RENDER & UI LOGIC ---
        function renderMethodology() {
            activateChatView();
            hideSuggestions();
            contentArea.innerHTML = `
                <div class="prose max-w-none text-slate-700 animate-fade-in">
                    <h2 class="text-2xl font-bold text-black border-b-2 border-brand-red pb-2 mb-4">How This Chatbot Works</h2>
                    <p class="mb-4">This chatbot is designed to be a specialized expert on financial instruments for climate action. Here’s how it reasons and provides answers:</p>
                    
                    <h3 class="text-xl font-semibold text-black mt-6">1. Core Knowledge Base</h3>
                    <p class="mb-4">The chatbot's primary source of information is a structured database built directly from the "CCFLA Financial Instruments Toolkit" file. This database contains the specific details for each financial instrument, including their descriptions, funding sources, and the sectors they apply to.</p>

                    <h3 class="text-xl font-semibold text-black mt-6">2. Smart Search & Reasoning</h3>
                    <p class="mb-2">When you ask a question, the chatbot follows a two-step process:</p>
                    <ul class="list-disc list-inside space-y-2">
                        <li><strong>If a match is found in the Core Knowledge Base:</strong> The chatbot takes all the detailed data about that instrument and sends it to Google's Gemini language model. It gives the AI a specific instruction: "Use this precise data to create a simple and clear explanation." This combines the accuracy of the toolkit data with the AI's ability to communicate in natural language.</li>
                        <li><strong>If no match is found:</strong> If your question is about a topic not in the core database, the chatbot then uses Gemini's general knowledge to find an answer. Crucially, it is instructed to stay strictly within the topic of climate finance to ensure the answers remain relevant.</li>
                    </ul>

                    <p class="mt-6">This two-step process ensures that the answers are as accurate and helpful as possible, prioritizing the expert data you provided while still being able to answer a broader range of related questions.</p>
                </div>
            `;
        }

        function activateChatView() {
            if (!isChatActive) {
                contentArea.innerHTML = ''; // Clear categories
                isChatActive = true;
            }
            startOverButton.classList.remove('hidden');
        }

        startOverButton.addEventListener('click', () => {
             isChatActive = false; // Reset chat state
             startInteractiveFlow();
        });
        methodologyButton.addEventListener('click', renderMethodology);
        
        function renderRelatedSuggestions(originalQuery, isCaseStudy = false) {
            let instrumentForSuggestions = originalQuery;
            if (isCaseStudy) {
                const caseStudyId = originalQuery.replace("case_study: ", "");
                const caseStudyInfo = caseStudyDatabase[caseStudyId];
                instrumentForSuggestions = `Tell me about ${caseStudyInfo.instrument}`;
            }

            const originalInstrumentInfo = findInstrumentInfo(instrumentForSuggestions);
            if (!originalInstrumentInfo) return; 

            const filteredInstruments = instrumentDatabase.filter(item => {
                return item.user_type.includes(userSelections.role) || item.user_type.includes("All");
            });
            
            let suggestions = [...new Set(filteredInstruments.map(item => `Tell me about ${item.instrument}`))]
                                .filter(q => q.toLowerCase() !== instrumentForSuggestions.toLowerCase());
            
            suggestions.sort(() => 0.5 - Math.random());

            if (suggestions.length > 0) {
                const suggestionBlock = document.createElement('div');
                suggestionBlock.id = 'suggestion-block';
                suggestionBlock.className = 'p-4 rounded-lg mt-4 animate-fade-in';

                const title = document.createElement('p');
                title.className = 'text-sm font-semibold text-slate-600 mb-3 text-center';
                title.textContent = 'You might also be interested in:';
                suggestionBlock.appendChild(title);

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-wrap gap-2 justify-center';
                
                if (originalInstrumentInfo.case_study_id && !isCaseStudy) {
                    const caseStudy = caseStudyDatabase[originalInstrumentInfo.case_study_id];
                    const btn = document.createElement('button');
                    btn.textContent = `Case Study: ${caseStudy.instrument}`;
                    btn.setAttribute("data-query", `case_study: ${originalInstrumentInfo.case_study_id}`);
                    btn.className = 'suggestion-btn bg-brand-red/10 text-brand-red font-semibold py-2 px-4 rounded-full hover:bg-brand-red/20';
                    btn.onclick = () => handleUserQuery(btn.getAttribute("data-query"));
                    buttonContainer.appendChild(btn);
                }
                
                suggestions.slice(0, 4).forEach(q => {
                    const btn = document.createElement('button');
                    btn.textContent = q.replace("Tell me about ", "");
                    btn.setAttribute("data-query", q);
                    btn.className = 'suggestion-btn bg-slate-100 text-slate-700 text-sm font-medium py-2 px-3 rounded-full hover:bg-slate-200';
                    btn.onclick = () => handleUserQuery(btn.getAttribute("data-query"));
                    buttonContainer.appendChild(btn);
                });

                suggestionBlock.appendChild(buttonContainer);
                contentArea.appendChild(suggestionBlock);
                contentArea.scrollTop = contentArea.scrollHeight;
            }
        }

        function renderSeeAllSuggestion(originalQuery, filteredList) {
            const suggestionBlock = document.createElement('div');
            suggestionBlock.id = 'suggestion-block';
            suggestionBlock.className = 'p-4 rounded-lg mt-4 animate-fade-in';

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex flex-wrap gap-2 justify-center';
            
            const btn = document.createElement('button');
            btn.textContent = `Show all ${filteredList.length} matching instruments`;
            btn.setAttribute("data-query", `show_all: ${originalQuery}`);
            btn.className = 'suggestion-btn bg-brand-red/10 text-brand-red font-semibold py-2 px-4 rounded-full hover:bg-brand-red/20';
            btn.onclick = () => handleUserQuery(btn.getAttribute("data-query"));
            buttonContainer.appendChild(btn);
            
            filteredList.slice(0, 2).forEach(item => {
                const q = `Tell me about ${item.instrument}`;
                const btn = document.createElement('button');
                btn.textContent = item.instrument;
                btn.setAttribute("data-query", q);
                btn.className = 'suggestion-btn bg-slate-100 text-slate-700 text-sm font-medium py-2 px-3 rounded-full hover:bg-slate-200';
                btn.onclick = () => handleUserQuery(btn.getAttribute("data-query"));
                buttonContainer.appendChild(btn);
            });

            suggestionBlock.appendChild(buttonContainer);
            contentArea.appendChild(suggestionBlock);
            contentArea.scrollTop = contentArea.scrollHeight;
        }

        function hideSuggestions() {
            const existingSuggestions = document.getElementById('suggestion-block');
            if (existingSuggestions) {
                existingSuggestions.remove();
            }
        }


        // --- CHAT LOGIC ---
        async function getGeminiResponse(promptForLLM) {
            const apiKey = "AIzaSyD2Ld45d6r_Lu8QDtGO6xJXKWAAi0LAwGw"; // API Key added
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const tempHistory = [
                { role: "model", parts: [{ text: systemPrompt }] },
                { role: "user", parts: [{ text: promptForLLM }] }
            ];

            const payload = { contents: tempHistory };
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content) {
                    return result.candidates[0].content.parts[0].text;
                }
                return "I'm sorry, I couldn't generate a response. Please try another question.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "Sorry, I'm having trouble connecting. Please try again in a moment.";
            }
        }

        function appendMessage(sender, message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'flex mb-4 animate-fade-in';

            const messageContent = document.createElement('div');
            messageContent.className = 'p-4 rounded-2xl max-w-lg';

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageContent.classList.add('bg-black', 'text-white', 'ml-8', 'rounded-br-lg');
                messageContent.textContent = message;
            } else { 
                messageWrapper.classList.add('justify-start');
                messageContent.classList.add('bg-slate-100', 'text-black', 'mr-8', 'rounded-bl-lg');
                
                let formattedMessage = message.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                             .replace(/\*(.*?)\*/g, '<em>$1</em>')
                                             .replace(/\n/g, '<br>');
                
                const listRegex = /(<br>|^)\s*[\*|\-]\s/g;
                if(listRegex.test(formattedMessage)){
                    formattedMessage = formattedMessage.replace(listRegex, '<br>• ');
                    formattedMessage = formattedMessage.replace(/(<br>•\s.*)+/g, (match) => `<ul class="list-none pl-2 space-y-1">${match.replace(/<br>•\s/g, '<li>• ')}</li></ul>`);
                }

                messageContent.innerHTML = formattedMessage;

                if (message === 'thinking') {
                    messageContent.innerHTML = `
                        <div class="thinking-bubble flex gap-1.5 items-center">
                            <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-slate-400 rounded-full"></span>
                        </div>
                    `;
                }
            }
            
            messageWrapper.appendChild(messageContent);
            contentArea.appendChild(messageWrapper);
            contentArea.scrollTop = contentArea.scrollHeight;
            return messageWrapper;
        }
        
        async function handleUserQuery(query) {
            if (!query.trim()) return;
            
            activateChatView();
            hideSuggestions(); 
            appendMessage('user', query);
            userInput.value = '';
            sendButton.disabled = true;
            
            const thinkingMessage = appendMessage('bot', 'thinking');

            // --- REVISED REASONING LOGIC ---
            let promptForLLM;
            let showRelatedSuggestions = true;
            let isCaseStudyQuery = false;

            if (query.startsWith("show_all:")) {
                const originalQuery = query.replace("show_all: ", "");
                const filteredList = filterInstrumentsByCriteria(originalQuery);
                const dataString = `Data: ${JSON.stringify(filteredList)}`;
                promptForLLM = `The user wants to see all instruments for their query '${originalQuery}'. Here is the full list from the database: ${dataString}. Please format this as a clear, bulleted list where each instrument is bolded, followed by a brief one-sentence description.`;
                showRelatedSuggestions = false; 
            } else if (query.startsWith("case_study:")) {
                const caseStudyId = query.replace("case_study: ", "");
                const caseStudyInfo = caseStudyDatabase[caseStudyId];
                const dataString = `Data: ${JSON.stringify(caseStudyInfo)}`;
                promptForLLM = `The user wants to know more about the case study: "${caseStudyInfo.title}". Please summarize the following case study data: ${dataString}`;
                isCaseStudyQuery = true;
            }
            else {
                const instrumentInfo = findInstrumentInfo(query);
                const filteredList = filterInstrumentsByCriteria(query);

                if (instrumentInfo) {
                    const dataString = `Data: ${JSON.stringify(instrumentInfo)}`;
                    promptForLLM = `The user asked about "${query}". Explain this using the following data, combining the information into a helpful paragraph: ${dataString}`;
                } else if (filteredList.length > 0) {
                    const dataString = `Data: ${JSON.stringify(filteredList.map(i => i.instrument))}`;
                    promptForLLM = `The user asked about "${query}". Based on the internal database, here is a list of relevant instruments: ${dataString}. Please summarize this list and explain why these instruments are suitable, highlighting 2-3 key examples.`;
                } else {
                    promptForLLM = `The user asked about "${query}". This was not found in the core instrument list. Use your general knowledge to explain this concept, but keep the answer strictly related to climate finance.`;
                    showRelatedSuggestions = false;
                }
            }

            const botResponse = await getGeminiResponse(promptForLLM);
            
            // Store the response if it was a detailed explanation
            if (findInstrumentInfo(query) && !isCaseStudyQuery) {
                lastDetailedResponse = botResponse;
            }
            
            contentArea.removeChild(thinkingMessage);
            appendMessage('bot', botResponse);
            sendButton.disabled = false;

            // Render suggestions based on the logic
            const filteredListCheck = filterInstrumentsByCriteria(query);
            if (showRelatedSuggestions) {
                if (findInstrumentInfo(query) || isCaseStudyQuery) {
                    renderRelatedSuggestions(query, isCaseStudyQuery);
                } else if (filteredListCheck.length > 0) {
                    renderSeeAllSuggestion(query, filteredListCheck);
                }
            }
        }

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleUserQuery(userInput.value);
        });

        // Initial Load
        window.onload = () => {
            startInteractiveFlow();
        };
    </script>
</body>
</html>
